<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Kiara Chat</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  </head>
  <body>
    <div class="row">
      <div class="col s8 offset-m2">
        <h1>Kiara Chat</h1>
        <p id="websocket-not-supported" style="display: none;">
          Your Browser does not support WebSocket.
        </p>
        <form id="form">
          <div class="row">
            <div class="input-field col s4">
              <input id="name" name="name" type="text" required class="validate">
              <label for="name">Name</label>
            </div>
            <div class="input-field col s4">
              <input id="message" name="message" type="text" required class="validate">
              <label for="name">Message</label>
            </div>
          </div>
          <input type="submit" value="Send" class="btn">
        </form>
        <div id="messages"></div>
      </div>
    </div>

    <script>
     var conn;

     const onFormSubmitted = e => {
       e.preventDefault();
       const msgFrom = document.getElementById('name').value;
       const msgBody = document.getElementById('message').value;
       const msg = {'from': msgFrom, 'body': msgBody};
       console.log('sending', msg);
       conn.send(JSON.stringify(msg));
       return false;
     };

     const onConnectionClosed = () => {
       // TODO: show dialog
       console.log('connection closed');
     };

     const onMessage = e => {
       const msg = JSON.parse(e.data);
       console.log('message received', msg);
       const messagesView = document.getElementById('messages');
       const msgView = document.createElement('p');
       const nameView = document.createElement('span');
       const bodyView = document.createElement('span');
       msgView.classList.add('card-panel', 'grey', 'lighten-5', 'z-depth-1');
       nameView.classList.add('chip');
       // bodyView.classList.add();
       nameView.innerText = msg.from;
       bodyView.innerText = msg.body;
       msgView.appendChild(nameView);
       msgView.appendChild(bodyView);
       messagesView.prepend(msgView);
     };

     const initialize = () => {
       const form = document.getElementById('form');
       form.addEventListener('submit', onFormSubmitted);

       if (!window['WebSocket']) {
         const msg = document.getElementById('websocket-not-supported');
         msg.style.display = 'block';
       }

       conn = new WebSocket('ws://' + document.location.host + '/ws');
       conn.addEventListener('close', onConnectionClosed);
       conn.addEventListener('message', onMessage);
     };

     window.addEventListener('load', initialize);

    </script>
  </body>
</html>
